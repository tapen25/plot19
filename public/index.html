<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Recognition (v2: Raw Data)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        #startButton {
            font-size: 1.5rem;
            padding: 20px 40px;
            border-radius: 10px;
            border: none;
            background-color: #007aff;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #status {
            font-size: 1.2rem;
            margin-top: 20px;
            color: #555;
        }
        #result {
            font-size: 3rem;
            font-weight: bold;
            margin-top: 10px;
            color: #007aff;
            min-height: 3rem;
        }
    </style>
</head>
<body>
    <button id="startButton">計測を開始</button>
    <div id="status">センサーへのアクセスを許可してください</div>
    <div id="result">...</div>

    <script>
        // -----------------------------------------------------------------
        // ★★★ 1. 設定項目 ★★★
        // -----------------------------------------------------------------

        // あなたがRenderでデプロイしたAPIのURL
        const API_URL = 'https://my-activity-predictor.onrender.com/predict'; 
        
        // 1回の予測で使用するサンプル数
        // ★★★ (最重要) 学習時の WINDOW_SIZE と一致させる ★★★
        const BUFFER_SIZE = 100; 

        // -----------------------------------------------------------------
        // 以下、メインロジック
        // -----------------------------------------------------------------

        const startButton = document.getElementById('startButton');
        const statusEl = document.getElementById('status');
        const resultEl = document.getElementById('result');

        let sensorDataBuffer = []; // ★ 生の {x, y, z} データを溜めるバッファ
        let isSensorRunning = false;

        // --- 1. センサーのパーミッションを要求 (変更なし) ---
        function requestSensorPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            startSensor();
                        } else {
                            statusEl.textContent = 'センサーへのアクセスが拒否されました';
                        }
                    })
                    .catch(error => {
                        statusEl.textContent = 'センサー許可エラー: ' + error.message;
                    });
            } else {
                startSensor();
            }
        }

        // --- 2. センサーのリスナーを開始 (変更なし) ---
        function startSensor() {
            statusEl.textContent = 'センサー待機中...';
            isSensorRunning = true;
            startButton.disabled = true;
            startButton.textContent = '計測中';
            window.addEventListener('devicemotion', handleMotion);
        }
        
        // --- 3. センサーデータ（生）の取得とバッファリング (★★★ 修正点 ★★★) ---
        function handleMotion(event) {
            if (!isSensorRunning) return;

            // 「重力加速度を除く」加速度 (acc) を取得
            const acc = event.acceleration; 

            if (acc === null || acc.x === null || acc.y === null || acc.z === null) {
                statusEl.textContent = '加速度データ(重力除く)を取得できません';
                return;
            }

            const SCALE_FACTOR = 0.1; // <-- 係数を追加 (0.1)
            
            sensorDataBuffer.push({
                x: acc.x * SCALE_FACTOR,
                y: acc.y * SCALE_FACTOR,
                z: acc.z * SCALE_FACTOR
            });

            // バッファが指定サイズ (100) に達したら、処理を実行
            if (sensorDataBuffer.length >= BUFFER_SIZE) {
                // バッファのコピーを渡して処理（非同期）
                // ★ 修正点: processData はもう計算しないが、名前はそのまま使う
                processData(sensorDataBuffer.slice()); 
                
                // バッファをクリアして次の収集を開始
                sensorDataBuffer = []; 
            }
        }
        
        // --- 4. 特徴量の計算 (!!! 修正点: 計算をやめて送信準備するだけ !!!) ---
        function processData(data) {
            statusEl.textContent = 'データを準備中...';
            
            // ★ 修正点: JavaScriptでの特徴量計算はすべて削除
            
            // data は {x,y,z} のオブジェクトが100個入ったリスト
            
            // 5. APIサーバーに送信
            //    app.py が期待する { "sensor_data": [...] } という形式で送る
            sendPrediction({ "sensor_data": data });
        }

        // --- 5. APIサーバーへ予測リクエストを送信 (★★★ 修正点 ★★★) ---
        async function sendPrediction(payload) { // 引数を features -> payload に変更
            statusEl.textContent = 'APIサーバーへ送信中...';
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // ★ 修正点: 特徴量(features)ではなく、生のデータ(payload)を送る
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `APIサーバーエラー: ${response.status}` }));
                    throw new Error(errorData.error || `APIサーバーエラー: ${response.status}`);
                }

                const result = await response.json();
                
                // 6. 結果の表示 (変更なし)
                if (result.predicted_label) {
                    statusEl.textContent = '予測完了';
                    const label = result.predicted_label;
                    
                    let color = '#007aff';
                    let text = label.charAt(0).toUpperCase() + label.slice(1);

                    if (label === 'stay') {
                        color = '#34C759'; 
                        text = 'Stay (静止)';
                    } else if (label === 'walk') {
                        color = '#007aff';
                        text = 'Walk (歩行)';
                    } else if (label === 'jog') {
                        color = '#FF3B30';
                        text = 'Jog (ジョギング)';
                    }
                    
                    resultEl.textContent = text;
                    resultEl.style.color = color;

                } else if (result.error) {
                    throw new Error(result.error);
                }

            } catch (error) {
                statusEl.textContent = `予測エラー: ${error.message}`;
                resultEl.textContent = 'Error';
                resultEl.style.color = '#FF3B30';
            }
        }

        // --- スタートボタンの処理 (変更なし) ---
        startButton.addEventListener('click', () => {
            if (!isSensorRunning) {
                requestSensorPermission();
            }
        });

    </script>
</body>
</html>